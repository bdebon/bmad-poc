# Story 3.2: Notion Entry Format

## Status

Done

## Story

**As a** developer,
**I want** entries created with the correct fields and formatting,
**so that** Benjamin can use them immediately.

## Acceptance Criteria

1. Chaque entrée contient : Titre, Description (justification Claude), URL source, Score, Tags, Date
2. Un champ "Rating" (select 1-5 étoiles) est créé vide pour le feedback manuel
3. Un champ "Sources" liste Reddit/HN avec liens
4. Le titre est formaté proprement (pas de caractères spéciaux cassés)
5. Les tags sont créés comme multi-select (Drama, Success Story, IA, etc.)

## Tasks / Subtasks

- [x] Task 1: Définir le mapping ScoredPost → Notion properties (AC: 1, 2, 3, 4, 5)

  - [x] Créer fonction `buildNotionProperties(post: ScoredPost): NotionProperties`
  - [x] Mapper title → Title (title property)
  - [x] Mapper justification → Description (rich_text)
  - [x] Mapper sourceUrls → Sources (rich_text avec liens)
  - [x] Mapper relevanceScore → Score (number)
  - [x] Mapper tags → Tags (multi_select)
  - [x] Ajouter Date (date property)
  - [x] Ajouter Rating vide (select)

- [x] Task 2: Implémenter le formatage du titre (AC: 4)

  - [x] Nettoyer les caractères spéciaux problématiques
  - [x] Tronquer si trop long (max 100 chars)
  - [x] Gérer les emojis correctement

- [x] Task 3: Implémenter le formatage des sources (AC: 3)

  - [x] Créer liens cliquables vers article + discussion
  - [x] Format: "Article | Reddit" ou "Article | HN"

- [x] Task 4: Implémenter les tags multi-select (AC: 5)

  - [x] Mapper les tags Claude vers les options Notion
  - [x] Tags prédéfinis : Drama, Success Story, IA, Carrière, Open Source, etc.

- [x] Task 5: Mettre à jour createNotionEntry (AC: 1, 2)

  - [x] Utiliser buildNotionProperties dans publisher
  - [x] Ajouter le Rating vide

- [x] Task 6: Écrire les tests
  - [x] Créer `tests/unit/notion-formatter.test.ts`
  - [x] Tester le mapping de chaque champ
  - [x] Tester le nettoyage du titre
  - [x] Tester le formatage des sources
  - [x] Tester les tags multi-select

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Story 3.1 (Notion API Integration)** — publisher module existant

### Schéma Database Notion

La database Notion doit avoir ces propriétés :

| Property    | Type         | Description                     |
| ----------- | ------------ | ------------------------------- |
| Title       | title        | Titre du post                   |
| Description | rich_text    | Justification Claude            |
| Sources     | rich_text    | Liens vers article + discussion |
| Score       | number       | Relevance score 1-10            |
| Tags        | multi_select | Drama, Success Story, IA, etc.  |
| Rating      | select       | 1-5 étoiles (vide initialement) |
| Date        | date         | Date de publication             |

### Notion Properties Format

```typescript
interface NotionProperties {
  Title: {
    title: [{ text: { content: string } }];
  };
  Description: {
    rich_text: [{ text: { content: string } }];
  };
  Sources: {
    rich_text: [{ text: { content: string; link?: { url: string } } }];
  };
  Score: {
    number: number;
  };
  Tags: {
    multi_select: Array<{ name: string }>;
  };
  Rating: {
    select: null; // Vide pour feedback manuel
  };
  Date: {
    date: { start: string }; // ISO 8601
  };
}
```

### Fonction buildNotionProperties

```typescript
function buildNotionProperties(post: ScoredPost): NotionProperties {
  return {
    Title: {
      title: [{ text: { content: sanitizeTitle(post.post.title) } }],
    },
    Description: {
      rich_text: [{ text: { content: post.justification } }],
    },
    Sources: {
      rich_text: buildSourcesRichText(post),
    },
    Score: {
      number: post.relevanceScore,
    },
    Tags: {
      multi_select: post.tags.map((tag) => ({ name: formatTagName(tag) })),
    },
    Rating: {
      select: null,
    },
    Date: {
      date: { start: new Date().toISOString().split("T")[0] },
    },
  };
}
```

### Formatage du Titre

```typescript
function sanitizeTitle(title: string): string {
  // Retirer caractères de contrôle
  let clean = title.replace(/[\x00-\x1F\x7F]/g, "");

  // Tronquer si trop long
  if (clean.length > 100) {
    clean = clean.slice(0, 97) + "...";
  }

  return clean;
}
```

### Formatage des Sources

```typescript
function buildSourcesRichText(post: ScoredPost): RichTextItem[] {
  const items: RichTextItem[] = [];

  // Lien article
  items.push({
    text: {
      content: "Article",
      link: { url: post.post.url },
    },
  });

  items.push({ text: { content: " | " } });

  // Lien discussion
  const sourceName = post.post.source === "reddit" ? "Reddit" : "HN";
  items.push({
    text: {
      content: sourceName,
      link: { url: post.post.sourceUrl },
    },
  });

  return items;
}
```

### Tags Mapping

```typescript
const TAG_MAPPING: Record<string, string> = {
  drama: "Drama",
  "success-story": "Success Story",
  ia: "IA",
  layoffs: "Layoffs",
  "big-tech": "Big Tech",
  "open-source": "Open Source",
  carriere: "Carrière",
  startup: "Startup",
};

function formatTagName(tag: string): string {
  return TAG_MAPPING[tag.toLowerCase()] || tag;
}
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── publisher/
│   └── index.ts              # Modifier pour utiliser buildNotionProperties
tests/
├── unit/
│   └── notion-formatter.test.ts
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/unit/notion-formatter.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)

**Tests requis:**

1. buildNotionProperties retourne le bon format
2. sanitizeTitle retire les caractères de contrôle
3. sanitizeTitle tronque à 100 chars
4. buildSourcesRichText crée les liens corrects
5. formatTagName mappe les tags correctement
6. Rating est null par défaut

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

- Created `src/publisher/notion-formatter.ts` with all formatting functions
- `buildNotionProperties()` transforms ScoredPost to Notion API format
- `sanitizeTitle()` removes control characters and truncates to 100 chars
- `buildSourcesRichText()` creates clickable "Article | Reddit/HN" links
- `formatTagName()` maps internal tags to display names (drama -> Drama, ia -> IA, etc.)
- Updated `src/publisher/index.ts` to use the new formatter
- Updated `tests/integration/publisher.test.ts` to match new property structure
- All 105 tests pass

### File List

- `src/publisher/notion-formatter.ts` (new)
- `src/publisher/index.ts` (modified)
- `tests/unit/notion-formatter.test.ts` (new)
- `tests/integration/publisher.test.ts` (modified)

---

## QA Results

_To be filled by QA agent_
