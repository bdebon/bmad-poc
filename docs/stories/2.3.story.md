# Story 2.3: Post Analysis & Scoring

## Status

Done

## Story

**As a** developer,
**I want** each post analyzed and scored by Claude,
**so that** I can identify the most relevant content.

## Acceptance Criteria

1. Chaque `UnifiedPost` est envoyé à Claude avec le prompt "Profil Benjamin"
2. Claude retourne un objet `ScoredPost` avec : score (1-10), justification, tags (drama/success/IA/etc.)
3. Les posts avec score < 5 sont marqués comme "rejetés" avec la raison
4. Le traitement est fait en batch avec un délai entre les appels (respect rate limits)
5. Les résultats sont loggés pour debugging
6. Un test valide le parsing de la réponse Claude

## Tasks / Subtasks

- [x] Task 1: Créer le type ScoredPost (AC: 2)

  - [x] Ajouter interface `ScoredPost` dans `src/types/posts.ts`
  - [x] Inclure tous les champs requis
  - [x] Exporter depuis `src/types/index.ts`

- [x] Task 2: Créer le schema Zod pour la réponse Claude (AC: 2)

  - [x] Ajouter `claudeResponseSchema` dans `src/config/schema.ts`
  - [x] Valider score (1-10), justification, tags, rejected, rejectionReason

- [x] Task 3: Implémenter l'analyse individuelle (AC: 1, 2, 3)

  - [x] Modifier `src/analyzer/index.ts`
  - [x] Implémenter `analyzePost(post: UnifiedPost): Promise<ScoredPost>`
  - [x] Construire le prompt avec post + benjamin-profile
  - [x] Parser la réponse JSON de Claude avec zod
  - [x] Marquer rejected=true si score < 5

- [x] Task 4: Implémenter le batch processing (AC: 4)

  - [x] Implémenter `analyzeBatch(posts: UnifiedPost[]): Promise<ScoredPost[]>`
  - [x] Ajouter délai entre chaque appel (500ms minimum)
  - [x] Traiter séquentiellement pour respecter rate limits
  - [x] Continuer même si un post échoue (log l'erreur, skip le post)

- [x] Task 5: Implémenter le logging (AC: 5)

  - [x] Logger chaque analyse : post title, score, tags
  - [x] Logger les rejets avec raison
  - [x] Logger le résumé batch : X analysés, Y acceptés, Z rejetés

- [x] Task 6: Écrire les tests (AC: 6)
  - [x] Mettre à jour `tests/integration/analyzer.test.ts`
  - [x] Tester le parsing d'une réponse Claude valide
  - [x] Tester le marquage rejected pour score < 5
  - [x] Tester le batch processing avec délai
  - [x] Tester la continuation sur erreur individuelle

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Story 2.1 (Claude API Integration)** — client Anthropic configuré
- **Story 2.2 (Benjamin Profile Prompt)** — prompt loader disponible

### Type ScoredPost [Source: architecture/data-models.md#scoredpost]

```typescript
interface ScoredPost {
  post: UnifiedPost; // Le post original
  relevanceScore: number; // 1-10
  justification: string; // 2-3 phrases
  tags: string[]; // ['drama', 'success-story', 'ia', etc.]
  rejected: boolean; // true si score < seuil
  rejectionReason: string | null;
  analyzedAt: Date;
}
```

### Construction du Prompt pour Claude

```typescript
function buildAnalysisPrompt(post: UnifiedPost, profilePrompt: string): string {
  return `${profilePrompt}

---

## Post à analyser

**Titre:** ${post.title}
**Source:** ${post.source}${post.subreddit ? ` (r/${post.subreddit})` : ""}
**Score plateforme:** ${post.score}
**Commentaires:** ${post.commentCount}
**URL:** ${post.url}

Analyse ce post et retourne un JSON avec ton évaluation.`;
}
```

### Parsing de la Réponse Claude

Claude retourne du texte. Il faut extraire le JSON :

```typescript
function parseClaudeResponse(content: string): AnalysisResult {
  // Chercher le bloc JSON dans la réponse
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new AnalyzerError("No JSON found in Claude response");
  }

  const parsed = JSON.parse(jsonMatch[0]);
  return claudeResponseSchema.parse(parsed);
}
```

### Batch Processing avec Délai

```typescript
async function analyzeBatch(posts: UnifiedPost[]): Promise<ScoredPost[]> {
  const results: ScoredPost[] = [];
  const DELAY_MS = 500; // Respecter rate limits

  for (const post of posts) {
    try {
      const scored = await analyzePost(post);
      results.push(scored);
      logger.info("analyzer", "Post analyzed", {
        title: post.title.slice(0, 50),
        score: scored.relevanceScore,
        rejected: scored.rejected,
      });
    } catch (error) {
      logger.error("analyzer", "Failed to analyze post", {
        title: post.title,
        error: error.message,
      });
      // Continue avec les autres posts
    }

    await sleep(DELAY_MS);
  }

  return results;
}
```

### Seuil de Rejet

```typescript
const REJECTION_THRESHOLD = 5;

// Dans analyzePost:
const rejected = result.score < REJECTION_THRESHOLD;
const rejectionReason = rejected
  ? `Score ${result.score} below threshold ${REJECTION_THRESHOLD}`
  : null;
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── analyzer/
│   ├── index.ts              # analyzePost, analyzeBatch
│   └── prompt-loader.ts      # Story 2.2
├── types/
│   └── posts.ts              # Ajouter ScoredPost
├── config/
│   └── schema.ts             # Ajouter claudeResponseSchema
tests/
├── integration/
│   └── analyzer.test.ts      # Étendre les tests
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/integration/analyzer.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Mock @anthropic-ai/sdk

**Tests requis:**

1. Parse correctement une réponse Claude avec JSON valide
2. Extrait le JSON même si entouré de texte
3. Marque rejected=true pour score < 5
4. Batch traite plusieurs posts avec délai
5. Continue le batch même si un post échoue
6. Log correctement les résultats

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None

### Completion Notes List

- Added `ScoredPost` interface to `src/types/posts.ts` with all required fields
- Added `claudeResponseSchema` Zod schema to `src/config/schema.ts` for validation
- Updated `parseAnalysisResponse` to extract JSON from text and validate with Zod
- Implemented `analyzeAndScorePost()` returning `ScoredPost` with threshold-based rejection
- Implemented `analyzeBatch()` with 500ms delay between requests and error resilience
- Added comprehensive logging: individual post scores, rejection reasons, batch summary
- Extended tests from 12 to 22 tests covering all new functionality

### File List

- `src/types/posts.ts` (modified - added ScoredPost interface)
- `src/types/index.ts` (modified - exported ScoredPost)
- `src/config/schema.ts` (modified - added claudeResponseSchema)
- `src/analyzer/index.ts` (modified - added analyzeAndScorePost, analyzeBatch, Zod validation)
- `tests/integration/analyzer.test.ts` (modified - added 10 new tests)

---

## QA Results

_To be filled by QA agent_
