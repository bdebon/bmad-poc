# Story 3.3: Main Pipeline Orchestration

## Status

Done

## Story

**As a** developer,
**I want** a main entry point that orchestrates the full pipeline,
**so that** everything runs in sequence.

## Acceptance Criteria

1. Un fichier `src/index.ts` orchestre : scrape → analyze → select → publish
2. Chaque étape est loggée avec timing (durée d'exécution)
3. Si une étape échoue, le pipeline s'arrête avec un message d'erreur clair
4. Un résumé final est loggé : "X posts scrapés, Y analysés, Z publiés sur Notion"
5. Le script peut être exécuté via `npm run pipeline`
6. Un mode `--dry-run` permet de tester sans publier sur Notion

## Tasks / Subtasks

- [x] Task 1: Implémenter le pipeline orchestrator (AC: 1)

  - [x] Modifier `src/index.ts`
  - [x] Implémenter `runPipeline(options?: PipelineOptions): Promise<PipelineResult>`
  - [x] Séquencer : loadConfig → scrapeAll → unify → analyze → select → publish

- [x] Task 2: Ajouter le timing à chaque étape (AC: 2)

  - [x] Créer helper `withTiming<T>(name: string, fn: () => Promise<T>): Promise<T>`
  - [x] Logger le temps d'exécution de chaque étape
  - [x] Logger le temps total du pipeline

- [x] Task 3: Implémenter la gestion d'erreurs (AC: 3)

  - [x] Capturer les erreurs de chaque étape
  - [x] Logger l'erreur avec contexte (étape, données)
  - [x] Arrêter le pipeline proprement
  - [x] Exit code 1 en cas d'erreur

- [x] Task 4: Implémenter le résumé final (AC: 4)

  - [x] Définir type `PipelineResult`
  - [x] Collecter les métriques à chaque étape
  - [x] Logger le résumé formaté

- [x] Task 5: Ajouter le script npm (AC: 5)

  - [x] Ajouter `"pipeline": "tsx src/index.ts"` dans package.json
  - [x] Vérifier l'exécution via `npm run pipeline`

- [x] Task 6: Implémenter le mode dry-run (AC: 6)

  - [x] Parser l'argument `--dry-run` depuis process.argv
  - [x] Si dry-run, skip l'étape publish
  - [x] Logger "[DRY-RUN] Would publish X posts to Notion"

- [x] Task 7: Écrire les tests
  - [x] Créer `tests/integration/pipeline.test.ts`
  - [x] Tester le happy path complet (avec mocks)
  - [x] Tester l'arrêt sur erreur
  - [x] Tester le mode dry-run

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Toutes les stories précédentes** — tous les modules doivent être implémentés

### Pipeline Flow [Source: architecture/core-workflows.md]

```
1. Load Config (config.yaml + env)
         ↓
2. Scrape Sources
   ├── scrapeReddit()
   └── scrapeHackerNews()
         ↓
3. Unify & Deduplicate
   └── unifyPosts() + deduplicateByUrl()
         ↓
4. Analyze with Claude
   └── analyzeBatch()
         ↓
5. Select Top Posts
   └── selectTopPosts()
         ↓
6. Publish to Notion (skip if dry-run)
   └── publishToNotion()
         ↓
7. Log Summary
```

### Interface Pipeline [Source: architecture/components.md#pipeline-orchestrator]

```typescript
interface PipelineOptions {
  dryRun?: boolean;
}

interface PipelineResult {
  success: boolean;
  scraped: number;
  analyzed: number;
  selected: number;
  published: number;
  duration: number; // ms
  error?: string;
}

async function runPipeline(options?: PipelineOptions): Promise<PipelineResult>;
```

### Helper withTiming

```typescript
async function withTiming<T>(
  stageName: string,
  fn: () => Promise<T>
): Promise<T> {
  const start = Date.now();
  logger.info("pipeline", `Starting ${stageName}`);

  try {
    const result = await fn();
    const duration = Date.now() - start;
    logger.info("pipeline", `Completed ${stageName}`, { duration });
    return result;
  } catch (error) {
    const duration = Date.now() - start;
    logger.error("pipeline", `Failed ${stageName}`, {
      duration,
      error: error.message,
    });
    throw error;
  }
}
```

### Main Function

```typescript
async function main(): Promise<void> {
  const dryRun = process.argv.includes("--dry-run");

  try {
    const result = await runPipeline({ dryRun });
    logSummary(result);
    process.exit(result.success ? 0 : 1);
  } catch (error) {
    logger.error("pipeline", "Pipeline failed", { error: error.message });
    process.exit(1);
  }
}

main();
```

### Logging Summary

```typescript
function logSummary(result: PipelineResult): void {
  const summary = `
Pipeline Summary:
  - Posts scraped: ${result.scraped}
  - Posts analyzed: ${result.analyzed}
  - Posts selected: ${result.selected}
  - Posts published: ${result.published}
  - Total duration: ${result.duration}ms
  - Status: ${result.success ? "SUCCESS" : "FAILED"}
  `;
  logger.info("pipeline", summary.trim());
}
```

### Dry-Run Mode

```typescript
if (options?.dryRun) {
  logger.info("pipeline", "[DRY-RUN] Would publish posts to Notion", {
    count: selectedPosts.length,
    titles: selectedPosts.map((p) => p.post.title.slice(0, 50)),
  });
  return { ...result, published: 0 };
}
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── index.ts                  # Pipeline orchestrator - ce fichier à modifier
tests/
├── integration/
│   └── pipeline.test.ts
```

### Package.json Script

```json
{
  "scripts": {
    "dev": "tsx src/index.ts",
    "pipeline": "tsx src/index.ts",
    "pipeline:dry": "tsx src/index.ts --dry-run"
  }
}
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/integration/pipeline.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Mock tous les modules externes (scrapers, analyzer, publisher)

**Tests requis:**

1. Pipeline complet s'exécute sans erreur (happy path)
2. Pipeline s'arrête et log erreur si scraper échoue
3. Pipeline s'arrête et log erreur si analyzer échoue
4. Dry-run skip la publication et log le message
5. Résumé final contient les bonnes métriques
6. Exit code 0 sur succès, 1 sur erreur

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug logs needed - implementation was straightforward

### Completion Notes List

- Implemented full pipeline orchestrator in `src/index.ts` with `runPipeline()` function
- Added `loadConfig()` function in `src/config/index.ts` to load and validate config.yaml
- Implemented `withTiming<T>()` helper that logs start/completion/failure with duration for each stage
- Pipeline catches errors and returns `PipelineResult` with `success: false` and error message
- Summary is logged using `logSummary()` showing scraped/analyzed/selected/published counts
- Added `npm run pipeline` and `npm run pipeline:dry` scripts to package.json
- Dry-run mode skips Notion publish and logs `[DRY-RUN] Would publish posts to Notion`
- Main entry point only executes when run directly (not during tests) via `process.env.VITEST` check
- Fixed pre-existing type issue in publisher by adding type cast for Notion properties
- All 6 integration tests pass covering: happy path, scraper error, analyzer error, dry-run mode, metrics, and exit codes

### File List

- `src/index.ts` - Modified: Pipeline orchestrator with runPipeline(), withTiming(), logSummary(), main()
- `src/config/index.ts` - Modified: Added loadConfig() and clearConfigCache() functions
- `src/publisher/index.ts` - Modified: Fixed type cast for Notion properties
- `src/publisher/notion-formatter.ts` - Modified: No changes needed (type was already correct)
- `tests/integration/pipeline.test.ts` - Created: 6 integration tests for pipeline
- `package.json` - Modified: Added pipeline and pipeline:dry scripts

---

## QA Results

_To be filled by QA agent_
