# Story 2.4: Top Posts Selection

## Status

Done

## Story

**As a** developer,
**I want** to select the top 3-4 posts from the scored results,
**so that** only the best content is sent to Notion.

## Acceptance Criteria

1. Les posts sont triés par score décroissant
2. Les 4 meilleurs posts sont sélectionnés (configurable via `config.yaml`)
3. En cas d'égalité, le post avec le plus d'engagement (score source + commentaires) gagne
4. Si moins de 4 posts passent le seuil (score >= 6), on prend ce qui est disponible
5. La fonction retourne un tableau `ScoredPost[]` prêt pour Notion

## Tasks / Subtasks

- [x] Task 1: Créer le module selector (AC: 1, 2, 3, 4, 5)

  - [x] Créer `src/selector/index.ts`
  - [x] Implémenter `selectTopPosts(posts: ScoredPost[], maxCount: number): ScoredPost[]`
  - [x] Filtrer les posts avec score >= seuil (configurable)
  - [x] Trier par relevanceScore décroissant
  - [x] Départager égalités par engagement (score + commentaires)
  - [x] Limiter au maxCount configuré

- [x] Task 2: Ajouter la config (AC: 2)

  - [x] Vérifier que `config.yaml` a `filtering.maxPosts` et `filtering.minScore`
  - [x] Lire ces valeurs depuis la config

- [x] Task 3: Implémenter la logique de tri (AC: 1, 3)

  - [x] Tri primaire : relevanceScore décroissant
  - [x] Tri secondaire : engagement (post.score + post.commentCount) décroissant

- [x] Task 4: Gérer les cas limites (AC: 4)

  - [x] 0 posts passent le seuil → retourner tableau vide
  - [x] Moins de maxCount posts → retourner tous ceux disponibles
  - [x] Logger le nombre de posts sélectionnés

- [x] Task 5: Écrire les tests (AC: 1, 2, 3, 4, 5)
  - [x] Créer `tests/unit/selector.test.ts`
  - [x] Tester le tri par score
  - [x] Tester le départage par engagement
  - [x] Tester la limite maxCount
  - [x] Tester le cas 0 posts éligibles
  - [x] Tester le cas moins que maxCount posts

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Story 2.3 (Post Analysis & Scoring)** — type `ScoredPost` disponible

### Interface Selector [Source: architecture/components.md#selector-module]

```typescript
selectTopPosts(posts: ScoredPost[], maxCount: number): ScoredPost[]
```

### Config Values [Source: architecture/data-models.md#config]

```yaml
filtering:
  minScore: 6 # Score minimum pour être sélectionné
  maxPosts: 4 # Nombre max de posts à retourner
```

### Algorithme de Sélection

```typescript
function selectTopPosts(
  posts: ScoredPost[],
  maxCount: number,
  minScore: number = 6
): ScoredPost[] {
  // 1. Filtrer les posts non rejetés avec score >= minScore
  const eligible = posts.filter(
    (p) => !p.rejected && p.relevanceScore >= minScore
  );

  // 2. Trier par score puis par engagement
  const sorted = eligible.sort((a, b) => {
    // Tri primaire : relevanceScore décroissant
    if (b.relevanceScore !== a.relevanceScore) {
      return b.relevanceScore - a.relevanceScore;
    }
    // Tri secondaire : engagement décroissant
    const engagementA = a.post.score + a.post.commentCount;
    const engagementB = b.post.score + b.post.commentCount;
    return engagementB - engagementA;
  });

  // 3. Limiter au maxCount
  return sorted.slice(0, maxCount);
}
```

### Logging

```typescript
logger.info("selector", "Posts selected", {
  total: posts.length,
  eligible: eligible.length,
  selected: result.length,
  topScore: result[0]?.relevanceScore ?? 0,
});
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── selector/
│   └── index.ts              # selectTopPosts
tests/
├── unit/
│   └── selector.test.ts
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/unit/selector.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Coverage:** 80% branches (module critique)

**Tests requis:**

1. Retourne max 4 posts quand plus de 4 éligibles
2. Trie par relevanceScore décroissant
3. Départage égalité par engagement (score + comments)
4. Filtre les posts avec score < minScore
5. Filtre les posts rejetés
6. Retourne tableau vide si aucun éligible
7. Retourne moins que maxCount si pas assez de posts

**Fixture de test:**

```typescript
const mockPosts: ScoredPost[] = [
  {
    relevanceScore: 8,
    post: { score: 100, commentCount: 50 },
    rejected: false,
  },
  {
    relevanceScore: 8,
    post: { score: 200, commentCount: 30 },
    rejected: false,
  }, // Gagne sur engagement
  {
    relevanceScore: 7,
    post: { score: 500, commentCount: 100 },
    rejected: false,
  },
  {
    relevanceScore: 5,
    post: { score: 1000, commentCount: 500 },
    rejected: false,
  }, // Exclu (< 6)
  { relevanceScore: 9, post: { score: 50, commentCount: 10 }, rejected: true }, // Exclu (rejected)
];
```

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - implementation completed without issues

### Completion Notes List

- Implemented `selectTopPosts` function in `src/selector/index.ts`
- Config values `filtering.minScore: 6` and `filtering.maxPosts: 4` already present in `config.yaml`
- Function filters out rejected posts and posts below minScore threshold
- Sorts by relevanceScore (desc), breaks ties by engagement (score + commentCount)
- Returns up to maxCount posts, handles edge cases (empty input, fewer than maxCount eligible)
- 10 unit tests covering all acceptance criteria and edge cases
- Lint passes, all tests pass (69/69)

### File List

- `src/selector/index.ts` (new)
- `tests/unit/selector.test.ts` (new)

---

## QA Results

_To be filled by QA agent_
