# Story 1.4: Unified Post Format & Deduplication

## Status

Done

## Story

**As a** developer,
**I want** a unified post format and deduplication logic,
**so that** posts from different sources can be processed uniformly.

## Acceptance Criteria

1. Un type `UnifiedPost` est défini avec les champs communs (titre, url, source, score, etc.)
2. Les posts Reddit et HN sont convertis vers ce format unifié
3. La déduplication identifie les posts pointant vers la même URL
4. Les doublons sont fusionnés en conservant le meilleur score et les deux sources
5. Un test unitaire valide la logique de déduplication

## Tasks / Subtasks

- [x] Task 1: Créer le type UnifiedPost (AC: 1)

  - [x] Ajouter l'interface `UnifiedPost` dans `src/types/posts.ts`
  - [x] Inclure tous les champs communs requis
  - [x] Exporter depuis `src/types/index.ts`

- [x] Task 2: Implémenter les convertisseurs (AC: 2)

  - [x] Créer `src/unifier/index.ts`
  - [x] Implémenter `convertRedditPost(post: RedditPost): UnifiedPost`
  - [x] Implémenter `convertHNPost(post: HNPost): UnifiedPost`
  - [x] Implémenter `unifyPosts(reddit: RedditPost[], hn: HNPost[]): UnifiedPost[]`

- [x] Task 3: Implémenter la déduplication (AC: 3, 4)

  - [x] Créer `src/unifier/deduplicator.ts`
  - [x] Implémenter `deduplicateByUrl(posts: UnifiedPost[]): UnifiedPost[]`
  - [x] Normaliser les URLs (retirer trailing slash, www, etc.)
  - [x] Fusionner les doublons : garder le meilleur score, combiner les sources
  - [x] Logger les doublons détectés

- [x] Task 4: Exporter le module (AC: 1, 2)

  - [x] Mettre à jour `src/unifier/index.ts` avec barrel export

- [x] Task 5: Écrire les tests (AC: 5)
  - [x] Créer `tests/unit/unifier.test.ts`
  - [x] Créer `tests/unit/deduplicator.test.ts`
  - [x] Tester la conversion RedditPost → UnifiedPost
  - [x] Tester la conversion HNPost → UnifiedPost
  - [x] Tester la détection de doublons par URL
  - [x] Tester la fusion avec meilleur score
  - [x] Tester la normalisation d'URL (www, trailing slash, http/https)

## Dev Notes

### Dépendance Story Précédente

Cette story dépend de :

- **Story 1.1 (Project Setup)** — structure projet
- **Story 1.2 (Reddit Scraper)** — type `RedditPost`
- **Story 1.3 (HN Scraper)** — type `HNPost`

### Type UnifiedPost [Source: architecture/data-models.md#unifiedpost]

```typescript
interface UnifiedPost {
  id: string; // Format: "{source}_{originalId}"
  title: string;
  url: string; // URL vers le contenu (article externe ou discussion)
  sourceUrl: string; // URL vers la discussion source (Reddit thread / HN comments)
  source: "reddit" | "hn"; // Provenance du post
  subreddit: string | null; // Subreddit d'origine (null pour HN)
  score: number; // Score/upvotes sur la plateforme source
  commentCount: number; // Nombre de commentaires
  author: string; // Auteur du post
  createdAt: Date; // Date de création du post
  scrapedAt: Date; // Date de scraping
}
```

### Logique de Conversion

**RedditPost → UnifiedPost:**

```typescript
{
  id: `reddit_${redditPost.id}`,
  title: redditPost.title,
  url: redditPost.url,
  sourceUrl: `https://reddit.com/r/${redditPost.subreddit}/comments/${redditPost.id}`,
  source: 'reddit',
  subreddit: redditPost.subreddit,
  score: redditPost.score,
  commentCount: redditPost.commentCount,
  author: redditPost.author,
  createdAt: redditPost.createdAt,
  scrapedAt: new Date()
}
```

**HNPost → UnifiedPost:**

```typescript
{
  id: `hn_${hnPost.id}`,
  title: hnPost.title,
  url: hnPost.url || `https://news.ycombinator.com/item?id=${hnPost.id}`,
  sourceUrl: `https://news.ycombinator.com/item?id=${hnPost.id}`,
  source: 'hn',
  subreddit: null,
  score: hnPost.score,
  commentCount: hnPost.commentCount,
  author: hnPost.author,
  createdAt: hnPost.createdAt,
  scrapedAt: new Date()
}
```

### Logique de Déduplication [Source: architecture/components.md#unifier-module]

**Interface:**

```typescript
deduplicateByUrl(posts: UnifiedPost[]): UnifiedPost[]
```

**Algorithme:**

1. Normaliser les URLs (toLowerCase, retirer www., retirer trailing /, forcer https)
2. Grouper par URL normalisée
3. Pour chaque groupe avec duplicates:
   - Garder le post avec le meilleur `score`
   - Combiner les `source` (si Reddit et HN pointent vers même article)
   - Logger: `logger.info('unifier', 'Duplicate found', { url, sources: ['reddit', 'hn'] })`

**Normalisation URL:**

```typescript
function normalizeUrl(url: string): string {
  const parsed = new URL(url);
  parsed.protocol = "https:";
  parsed.hostname = parsed.hostname.replace(/^www\./, "");
  parsed.pathname = parsed.pathname.replace(/\/$/, "");
  return parsed.toString();
}
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── unifier/
│   ├── index.ts          # unifyPosts + convertisseurs
│   └── deduplicator.ts   # deduplicateByUrl
├── types/
│   └── posts.ts          # Ajouter UnifiedPost
tests/
├── unit/
│   ├── unifier.test.ts
│   └── deduplicator.test.ts
```

### Edge Cases à Gérer

1. **URL identique mais protocole différent** (http vs https) → normaliser
2. **www vs non-www** → normaliser
3. **Trailing slash** → retirer
4. **Posts sans URL externe** (Ask HN) → utiliser sourceUrl comme url
5. **Score égal lors de fusion** → garder le premier trouvé

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/unit/unifier.test.ts`, `tests/unit/deduplicator.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Coverage:** 80% branches pour ce module critique

**Tests requis pour unifier.test.ts:**

1. Convertit correctement un RedditPost en UnifiedPost
2. Convertit correctement un HNPost en UnifiedPost
3. Gère un HNPost sans URL externe
4. Combine correctement posts Reddit et HN

**Tests requis pour deduplicator.test.ts:**

1. Retourne posts inchangés si pas de doublons
2. Détecte doublons avec URLs identiques
3. Détecte doublons avec www vs non-www
4. Détecte doublons avec http vs https
5. Détecte doublons avec trailing slash
6. Fusionne en gardant le meilleur score
7. Combine les sources lors de la fusion

## Change Log

| Date       | Version | Description                             | Author            |
| ---------- | ------- | --------------------------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft                           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete, all tests pass | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no debug issues encountered

### Completion Notes List

- All 5 tasks completed successfully
- UnifiedPost type added to src/types/posts.ts with all required fields
- Converter functions implemented: convertRedditPost, convertHNPost, unifyPosts
- Deduplication logic with URL normalization (www, trailing slash, http/https)
- Barrel exports configured in src/unifier/index.ts
- 16 new tests added (4 in unifier.test.ts, 12 in deduplicator.test.ts)
- All 31 tests pass, linting clean

### File List

**New files:**

- src/unifier/index.ts
- src/unifier/deduplicator.ts
- tests/unit/unifier.test.ts
- tests/unit/deduplicator.test.ts

**Modified files:**

- src/types/posts.ts (added UnifiedPost interface)
- src/types/index.ts (exported UnifiedPost)

---

## QA Results

_To be filled by QA agent_
