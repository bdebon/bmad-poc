# Story 3.4: GitHub Actions Automation

## Status

Ready for Review

## Story

**As a** developer,
**I want** the pipeline to run automatically every day via GitHub Actions,
**so that** Benjamin receives his daily digest without manual intervention.

## Acceptance Criteria

1. Un workflow `.github/workflows/daily-pipeline.yml` est créé
2. Le cron est configuré pour s'exécuter 1x par jour (ex: 6h du matin UTC)
3. Les secrets (API keys) sont configurés via GitHub Secrets
4. Le workflow installe les dépendances, build, et exécute le pipeline
5. En cas d'échec, une notification est envoyée (GitHub email par défaut)
6. Les logs d'exécution sont accessibles dans l'onglet Actions
7. Un `workflow_dispatch` permet de déclencher manuellement le pipeline

## Tasks / Subtasks

- [x] Task 1: Créer la structure GitHub Actions (AC: 1)

  - [x] Créer `.github/workflows/` si non existant
  - [x] Créer `daily-pipeline.yml`

- [x] Task 2: Configurer le trigger cron (AC: 2)

  - [x] Ajouter `schedule` avec cron `0 6 * * *` (6h UTC)
  - [x] Documenter le timezone dans un commentaire

- [x] Task 3: Ajouter workflow_dispatch (AC: 7)

  - [x] Permettre le déclenchement manuel depuis l'UI GitHub

- [x] Task 4: Configurer le job (AC: 4)

  - [x] Utiliser `ubuntu-latest`
  - [x] Setup Node.js 20
  - [x] Cache npm
  - [x] `npm ci` pour installer les dépendances
  - [x] `npm run pipeline` pour exécuter

- [x] Task 5: Configurer les secrets (AC: 3)

  - [x] Documenter les secrets requis dans le workflow
  - [x] Passer les secrets via `env:`
  - [x] Liste : BRIGHT_DATA_API_KEY, ANTHROPIC_API_KEY, NOTION_API_KEY, NOTION_DATABASE_ID

- [x] Task 6: Configurer les notifications (AC: 5, 6)

  - [x] Par défaut, GitHub envoie des emails sur échec
  - [x] Ajouter `timeout-minutes: 10` pour éviter les runs infinis

- [x] Task 7: Ajouter un workflow CI (optionnel mais recommandé)

  - [x] Créer `.github/workflows/ci.yml`
  - [x] Trigger sur push/PR
  - [x] Exécuter lint + tests

- [x] Task 8: Documenter la configuration
  - [x] Ajouter section dans README sur les GitHub Secrets requis
  - [x] Documenter comment déclencher manuellement

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Story 3.3 (Pipeline Orchestration)** — `npm run pipeline` fonctionnel

### Workflow Daily Pipeline [Source: architecture/infrastructure-and-deployment.md]

```yaml
# .github/workflows/daily-pipeline.yml
name: Daily Tech Watch Pipeline

on:
  schedule:
    - cron: "0 6 * * *" # 6h UTC = 7h Paris (hiver) / 8h (été)
  workflow_dispatch: # Manual trigger

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # NFR2 compliance

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - run: npm run pipeline
        env:
          BRIGHT_DATA_API_KEY: ${{ secrets.BRIGHT_DATA_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
```

### Workflow CI (optionnel)

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm audit --audit-level=high
```

### GitHub Secrets Configuration

Les secrets suivants doivent être configurés dans GitHub (Settings → Secrets → Actions) :

| Secret                | Description                          |
| --------------------- | ------------------------------------ |
| `BRIGHT_DATA_API_KEY` | Clé API Bright Data pour le scraping |
| `ANTHROPIC_API_KEY`   | Clé API Anthropic pour Claude        |
| `NOTION_API_KEY`      | Token d'intégration Notion           |
| `NOTION_DATABASE_ID`  | ID de la database Notion cible       |

### Cron Schedule

Le cron `0 6 * * *` signifie :

- Minute: 0
- Heure: 6 (UTC)
- Jour du mois: \* (tous)
- Mois: \* (tous)
- Jour de la semaine: \* (tous)

**6h UTC = 7h Paris (hiver) / 8h Paris (été)**

### Notifications

GitHub Actions envoie par défaut des notifications email sur :

- Échec d'un workflow
- Workflow réussi après un échec précédent

Les notifications peuvent être configurées dans : Settings → Notifications

### Timeout

`timeout-minutes: 10` assure que le workflow ne tourne pas indéfiniment en cas de problème. Selon l'architecture (NFR2), le pipeline doit s'exécuter en moins de 10 minutes.

### Source Tree [Source: architecture/source-tree.md]

```
.github/
└── workflows/
    ├── daily-pipeline.yml    # Ce fichier à créer
    └── ci.yml                # Optionnel mais recommandé
```

## Testing

### Validation Manuelle

Cette story ne nécessite pas de tests automatisés mais une validation manuelle :

1. **Vérifier la syntaxe YAML**

   - Pas d'erreur de parsing dans l'onglet Actions

2. **Tester workflow_dispatch**

   - Aller dans Actions → Daily Tech Watch Pipeline → Run workflow
   - Vérifier que le pipeline se lance

3. **Vérifier les logs**

   - Les logs de chaque step sont visibles
   - Les secrets ne sont pas exposés

4. **Tester le dry-run** (optionnel)
   - Modifier temporairement le workflow pour utiliser `--dry-run`
   - Vérifier que le pipeline s'exécute sans publier

### Checklist de Validation

- [ ] Le fichier YAML est syntaxiquement correct
- [ ] Le workflow apparaît dans l'onglet Actions
- [ ] Le déclenchement manuel fonctionne
- [ ] Les secrets sont bien passés (pas d'erreur "secret not found")
- [ ] Le pipeline s'exécute avec succès
- [ ] Les logs sont accessibles et lisibles

## Change Log

| Date       | Version | Description   | Author         |
| ---------- | ------- | ------------- | -------------- |
| 2025-12-10 | 0.1     | Initial draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no issues encountered during implementation.

### Completion Notes List

- Created `.github/workflows/daily-pipeline.yml` with cron schedule (6h UTC), workflow_dispatch, Node 20 setup, npm cache, and secrets configuration
- Created `.github/workflows/ci.yml` with push/PR triggers, lint, test, and security audit steps
- Created `tech-watch-tool/README.md` documenting GitHub Secrets requirements and manual trigger instructions
- Lint passes; 3 pre-existing test failures (retry timeout tests unrelated to this story)

### File List

| File                                   | Action  |
| -------------------------------------- | ------- |
| `.github/workflows/daily-pipeline.yml` | Created |
| `.github/workflows/ci.yml`             | Created |
| `tech-watch-tool/README.md`            | Created |

---

## QA Results

_To be filled by QA agent_
