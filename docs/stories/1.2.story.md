# Story 1.2: Reddit Scraper

## Status

Done

## Story

**As a** developer,
**I want** to scrape posts from configured subreddits via Bright Data,
**so that** I can collect raw content for analysis.

## Acceptance Criteria

1. Le scraper se connecte à Bright Data avec les credentials depuis `.env`
2. Les subreddits à scraper sont configurables via `config.yaml`
3. Le scraper récupère les top posts (hot/top) des dernières 24h de chaque subreddit
4. Chaque post contient : titre, URL, score, nombre de commentaires, subreddit source
5. Les posts sont retournés dans un format TypeScript typé (`RedditPost[]`)
6. Les erreurs de connexion/scraping sont loggées proprement
7. Un test unitaire valide le parsing des données

## Tasks / Subtasks

- [x] Task 1: Créer le type RedditPost (AC: 5)

  - [x] Créer `src/types/posts.ts` avec l'interface `RedditPost`
  - [x] Exporter depuis `src/types/index.ts`

- [x] Task 2: Créer le schéma de validation Zod pour RedditPost (AC: 5)

  - [x] Ajouter le schema `redditPostSchema` dans `src/config/schema.ts`
  - [x] Valider tous les champs requis (title, url, score, num_comments, subreddit, author, created_utc)

- [x] Task 3: Implémenter le scraper Reddit (AC: 1, 2, 3, 4)

  - [x] Créer `src/scrapers/reddit.ts`
  - [x] Implémenter `scrapeReddit(config: RedditConfig): Promise<RedditPost[]>`
  - [x] Lire `BRIGHT_DATA_API_KEY` depuis `process.env`
  - [x] Lire les subreddits depuis config.yaml
  - [x] Appeler Bright Data API : POST /trigger puis GET /snapshot/{id}
  - [x] Parser et valider la réponse avec zod

- [x] Task 4: Implémenter la gestion d'erreurs (AC: 6)

  - [x] Créer `ScraperError` dans `src/types/errors.ts` si non existant
  - [x] Implémenter retry avec backoff exponentiel (3 retries, 1s/2s/4s)
  - [x] Logger les erreurs avec format JSON structuré
  - [x] Timeout de 30s pour Bright Data

- [x] Task 5: Exporter le module (AC: 5)

  - [x] Mettre à jour `src/scrapers/index.ts` avec barrel export

- [x] Task 6: Écrire les tests (AC: 7)
  - [x] Créer `tests/unit/reddit-scraper.test.ts`
  - [x] Créer fixture JSON dans `tests/fixtures/reddit-response.json`
  - [x] Tester le parsing des données valides
  - [x] Tester la gestion des données invalides
  - [x] Tester le comportement en cas d'erreur API (mock)

## Dev Notes

### Dépendance Story Précédente

Cette story dépend de **Story 1.1 (Project Setup)** qui doit être complétée pour avoir :

- Structure de projet TypeScript
- config.yaml avec la liste des subreddits
- .env avec BRIGHT_DATA_API_KEY

### Type RedditPost [Source: architecture/data-models.md]

```typescript
interface RedditPost {
  id: string; // ID Reddit original
  title: string;
  url: string; // URL vers le contenu
  sourceUrl: string; // URL vers le thread Reddit
  subreddit: string;
  score: number;
  commentCount: number; // num_comments dans l'API
  author: string;
  createdAt: Date; // created_utc converti
}
```

### Bright Data API [Source: architecture/external-apis.md#bright-data]

**Base URL:** `https://api.brightdata.com/datasets/v3/`

**Endpoints:**

- `POST /trigger` — Déclencher la collecte
- `GET /snapshot/{id}` — Récupérer les résultats

**Response Format:**

```json
{
  "title": "Post title",
  "url": "https://...",
  "score": 1234,
  "num_comments": 89,
  "author": "username",
  "created_utc": 1702234567,
  "subreddit": "programming"
}
```

**Authentication:** Header `Authorization: Bearer ${BRIGHT_DATA_API_KEY}`

### Error Handling [Source: architecture/error-handling-strategy.md]

```typescript
class ScraperError extends PipelineError {
  constructor(message: string, public readonly cause?: Error) {
    super(message);
  }
}
```

**Retry Policy Bright Data:**

- 3 retries
- Exponential backoff: 1s, 2s, 4s
- Timeout: 30s

**Logging Format:**

```typescript
logger.error("scraper", "Bright Data API failed", {
  error: err.message,
  attempt: 2,
});
```

### Interface Scraper [Source: architecture/components.md#scrapers-module]

```typescript
scrapeReddit(config: RedditConfig): Promise<RedditPost[]>
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── scrapers/
│   ├── index.ts          # Barrel export
│   └── reddit.ts         # Ce fichier à créer
├── types/
│   ├── index.ts
│   └── posts.ts          # RedditPost type
tests/
├── unit/
│   └── reddit-scraper.test.ts
├── fixtures/
│   └── reddit-response.json
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/unit/reddit-scraper.test.ts`
- **Fixture:** `tests/fixtures/reddit-response.json`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Mock fetch pour simuler Bright Data

**Tests requis:**

1. Parse correctement une réponse Bright Data valide
2. Rejette une réponse avec champs manquants (zod validation)
3. Retry sur erreur 5xx
4. Throw ScraperError après 3 retries échoués

## Change Log

| Date       | Version | Description                                         | Author            |
| ---------- | ------- | --------------------------------------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft                                       | SM Agent (Bob)    |
| 2025-12-10 | 1.0     | Implementation complete                             | Dev Agent (James) |
| 2025-12-10 | 1.1     | Fixed Bright Data API format after real API testing | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Initial API format from architecture docs was incorrect - Bright Data "Discover by Subreddit URL" requires different params
- Fixed: Added `type=discover_new&discover_by=subreddit_url&limit_per_input=N` to trigger URL
- Fixed: Body format changed to `{url, sort_by, sort_by_time, keyword}` instead of simple `{url}`
- Fixed: Response schema updated to match actual Bright Data format (post_id, user_posted, community_name, num_upvotes, date_posted)

### Completion Notes List

- Implemented RedditPost type with all required fields (id, title, url, sourceUrl, subreddit, score, commentCount, author, createdAt)
- Created Zod schemas for Bright Data API response validation and config.yaml validation
- Implemented scrapeReddit() with full Bright Data API integration (trigger + snapshot polling)
- Added retry logic with exponential backoff (3 retries, 1s/2s/4s delays)
- Implemented 30s timeout for API calls
- Created structured JSON logger utility
- All 7 tests passing (parsing, validation, retry, error handling)
- **Tested with real Bright Data API** - Successfully retrieved 5 posts from r/programming
- Bright Data API uses "Discover by Subreddit URL" mode with params: `sort_by=Hot`, `sort_by_time=Today`

### File List

- `src/types/posts.ts` - RedditPost interface (created)
- `src/types/errors.ts` - PipelineError and ScraperError classes (created)
- `src/types/index.ts` - Types barrel export (modified)
- `src/config/schema.ts` - Zod schemas for validation (modified)
- `src/scrapers/reddit.ts` - Reddit scraper implementation (created)
- `src/scrapers/index.ts` - Scrapers barrel export (modified)
- `src/utils/logger.ts` - Structured JSON logger (created)
- `src/utils/index.ts` - Utils barrel export (created)
- `tests/unit/reddit-scraper.test.ts` - Unit tests for Reddit scraper (created)
- `tests/fixtures/reddit-response.json` - Test fixture data (created)
- `scripts/test-reddit-scraper.ts` - Manual test script (created)
- `scripts/test-full-flow.ts` - Full flow debug script (created)

---

## QA Results

_To be filled by QA agent_
