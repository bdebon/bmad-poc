# Story 1.3: Hacker News Scraper

## Status

Done

## Story

**As a** developer,
**I want** to scrape the Hacker News front page via the official API,
**so that** I can collect tech news for analysis.

## Acceptance Criteria

1. Le scraper récupère les posts de la front page HN (top 30)
2. Chaque post contient : titre, URL, score, nombre de commentaires, auteur
3. Les posts sont retournés dans un format TypeScript typé (`HNPost[]`)
4. Le scraper gère les "Ask HN" et "Show HN" comme des posts normaux
5. Les erreurs sont loggées proprement
6. Un test unitaire valide le parsing des données

## Tasks / Subtasks

- [x] Task 1: Créer le type HNPost (AC: 2, 3)

  - [x] Ajouter l'interface `HNPost` dans `src/types/posts.ts`
  - [x] Exporter depuis `src/types/index.ts`

- [x] Task 2: Créer le schéma de validation Zod pour HNPost (AC: 3)

  - [x] Ajouter le schema `hnPostSchema` dans `src/config/schema.ts`
  - [x] Valider tous les champs requis (id, title, url, score, descendants, by, time, type)

- [x] Task 3: Implémenter le scraper HN (AC: 1, 2, 4)

  - [x] Créer `src/scrapers/hackernews.ts`
  - [x] Implémenter `scrapeHackerNews(config: HNConfig): Promise<HNPost[]>`
  - [x] GET /topstories.json pour récupérer les IDs
  - [x] GET /item/{id}.json pour chaque post (limiter à 30)
  - [x] Paralléliser les requêtes pour performance
  - [x] Gérer les posts sans URL externe (Ask HN, etc.) → utiliser URL HN

- [x] Task 4: Implémenter la gestion d'erreurs (AC: 5)

  - [x] Utiliser `ScraperError` existant
  - [x] Implémenter retry avec backoff (3 retries, 500ms)
  - [x] Timeout de 10s
  - [x] Logger les erreurs avec format JSON structuré

- [x] Task 5: Exporter le module (AC: 3)

  - [x] Mettre à jour `src/scrapers/index.ts` avec barrel export

- [x] Task 6: Écrire les tests (AC: 6)
  - [x] Créer `tests/unit/hackernews-scraper.test.ts`
  - [x] Créer fixtures JSON dans `tests/fixtures/hn-topstories.json` et `tests/fixtures/hn-item.json`
  - [x] Tester le parsing des données valides
  - [x] Tester les posts "Ask HN" sans URL externe
  - [x] Tester le comportement en cas d'erreur API

## Dev Notes

### Dépendance Story Précédente

Cette story dépend de :

- **Story 1.1 (Project Setup)** — structure projet
- **Story 1.2 (Reddit Scraper)** — types de base et pattern de scraper établis

### Type HNPost [Source: architecture/data-models.md]

```typescript
interface HNPost {
  id: number; // ID HN
  title: string;
  url: string | null; // Peut être null pour Ask HN
  score: number;
  commentCount: number; // "descendants" dans l'API
  author: string; // "by" dans l'API
  createdAt: Date; // "time" converti (unix timestamp)
  type: string; // "story", "ask", "show", etc.
}
```

### Hacker News API [Source: architecture/external-apis.md#hacker-news-api]

**Base URL:** `https://hacker-news.firebaseio.com/v0/`

**Endpoints:**

- `GET /topstories.json` — Retourne array de 500 IDs
- `GET /item/{id}.json` — Détails d'un item

**Response Format (item):**

```json
{
  "id": 12345,
  "title": "Show HN: Something cool",
  "url": "https://...",
  "score": 234,
  "descendants": 45,
  "by": "username",
  "time": 1702234567,
  "type": "story"
}
```

**Notes importantes:**

- API publique, pas d'authentification
- Pas de rate limit documenté (usage raisonnable)
- `url` peut être absent pour "Ask HN" → utiliser `https://news.ycombinator.com/item?id={id}`
- `descendants` = nombre de commentaires

### Error Handling [Source: architecture/error-handling-strategy.md]

**Retry Policy HN API:**

- 3 retries
- Backoff: 500ms fixe
- Timeout: 10s

### Interface Scraper [Source: architecture/components.md#scrapers-module]

```typescript
scrapeHackerNews(config: HNConfig): Promise<HNPost[]>
```

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── scrapers/
│   ├── index.ts          # Barrel export
│   ├── reddit.ts         # Story 1.2
│   └── hackernews.ts     # Ce fichier à créer
├── types/
│   └── posts.ts          # Ajouter HNPost
tests/
├── unit/
│   └── hackernews-scraper.test.ts
├── fixtures/
│   ├── hn-topstories.json
│   └── hn-item.json
```

### Performance Tip

Pour les 30 requêtes item, utiliser `Promise.all` avec un batch de 10 pour éviter de surcharger l'API :

```typescript
// Paralléliser par batches de 10
const batchSize = 10;
for (let i = 0; i < ids.length; i += batchSize) {
  const batch = ids.slice(i, i + batchSize);
  const results = await Promise.all(batch.map((id) => fetchItem(id)));
  posts.push(...results);
}
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/unit/hackernews-scraper.test.ts`
- **Fixtures:** `tests/fixtures/hn-*.json`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Mock fetch pour simuler HN API

**Tests requis:**

1. Parse correctement une liste de top stories
2. Parse correctement un item HN standard
3. Gère un "Ask HN" sans URL externe
4. Retry sur erreur réseau
5. Respecte la limite de 30 posts

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-10 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - implementation completed without issues

### Completion Notes List

- HNPost type added to `src/types/posts.ts` with all required fields (id, title, url, score, commentCount, author, createdAt, type)
- Zod schemas created: `hnApiItemSchema` for API response validation, `hnTopStoriesSchema` for topstories array
- Scraper implements batched fetching (10 parallel requests) to avoid API overload
- Ask HN posts without external URL automatically get HN item URL fallback
- Retry logic: 3 retries with 500ms fixed backoff, 10s timeout
- All 8 HN scraper tests pass, covering valid parsing, Ask HN handling, limit enforcement, retry behavior, and error handling

### File List

- `src/types/posts.ts` - Modified (added HNPost interface)
- `src/types/index.ts` - Modified (exported HNPost)
- `src/config/schema.ts` - Modified (added hnApiItemSchema, hnTopStoriesSchema)
- `src/scrapers/hackernews.ts` - Created (main scraper implementation)
- `src/scrapers/index.ts` - Modified (barrel export)
- `tests/unit/hackernews-scraper.test.ts` - Created (8 test cases)
- `tests/fixtures/hn-topstories.json` - Created
- `tests/fixtures/hn-item.json` - Created
- `tests/fixtures/hn-ask-item.json` - Created

---

## QA Results

_To be filled by QA agent_
