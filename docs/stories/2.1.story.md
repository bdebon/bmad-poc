# Story 2.1: Claude API Integration

## Status

Done

## Story

**As a** developer,
**I want** to integrate Claude API with the Anthropic SDK,
**so that** I can send posts for analysis.

## Acceptance Criteria

1. Le package `@anthropic-ai/sdk` est installé et configuré
2. La clé API est lue depuis les variables d'environnement
3. Une fonction `analyzePost(post: UnifiedPost)` envoie un post à Claude et retourne la réponse
4. Le rate limiting et les erreurs API sont gérés avec retry (3 tentatives max)
5. Un test unitaire avec mock valide l'intégration

## Tasks / Subtasks

- [x] Task 1: Installer le SDK Anthropic (AC: 1)

  - [x] `npm install @anthropic-ai/sdk`
  - [x] Vérifier que le package est ajouté au package.json

- [x] Task 2: Créer le module analyzer (AC: 2, 3)

  - [x] Créer `src/analyzer/index.ts`
  - [x] Lire `ANTHROPIC_API_KEY` depuis `process.env`
  - [x] Initialiser le client Anthropic
  - [x] Implémenter `analyzePost(post: UnifiedPost, prompt: string): Promise<AnalysisResult>`

- [x] Task 3: Définir les types de réponse (AC: 3)

  - [x] Créer interface `AnalysisResult` dans `src/types/posts.ts`
  - [x] Inclure : score, justification, tags, rejected, rejectionReason

- [x] Task 4: Implémenter la gestion d'erreurs et retry (AC: 4)

  - [x] Créer `AnalyzerError` dans `src/types/errors.ts`
  - [x] Implémenter retry avec backoff exponentiel (3 retries)
  - [x] Gérer les erreurs 429 (rate limit) avec délai plus long
  - [x] Timeout de 60s pour Claude API
  - [x] Logger les erreurs avec format structuré

- [x] Task 5: Exporter le module (AC: 3)

  - [x] Mettre à jour `src/analyzer/index.ts` avec barrel export

- [x] Task 6: Écrire les tests (AC: 5)
  - [x] Créer `tests/integration/analyzer.test.ts`
  - [x] Mock le SDK Anthropic
  - [x] Tester l'envoi d'un post et parsing de la réponse
  - [x] Tester le retry sur erreur 429
  - [x] Tester le timeout

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Epic 1 complet** — types `UnifiedPost` disponibles

### Claude API [Source: architecture/external-apis.md#claude-api]

**Base URL:** `https://api.anthropic.com/v1`

**Endpoint:**

- `POST /messages` — Analyse du post

**Authentication:** Header `x-api-key: ${ANTHROPIC_API_KEY}`

**Rate Limits:** Tier 1: 60 RPM, 60K tokens/min

**Modèle recommandé:** `claude-3-haiku-20240307` (coût minimal)

### SDK Anthropic [Source: architecture/tech-stack.md]

```typescript
import Anthropic from "@anthropic-ai/sdk";

const client = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

const response = await client.messages.create({
  model: "claude-3-haiku-20240307",
  max_tokens: 1024,
  messages: [{ role: "user", content: prompt }],
});
```

### Interface Analyzer [Source: architecture/components.md#analyzer-module]

```typescript
analyzePost(post: UnifiedPost, profile: string): Promise<ScoredPost>
analyzeBatch(posts: UnifiedPost[], profile: string): Promise<ScoredPost[]>
```

### Type AnalysisResult

```typescript
interface AnalysisResult {
  score: number; // 1-10
  justification: string; // 2-3 phrases
  tags: string[]; // ['drama', 'ia', 'success-story', etc.]
  rejected: boolean;
  rejectionReason: string | null;
}
```

### Error Handling [Source: architecture/error-handling-strategy.md]

```typescript
class AnalyzerError extends PipelineError {
  constructor(message: string, public readonly cause?: Error) {
    super(message);
  }
}
```

**Retry Policy Claude API:**

- 3 retries
- Exponential backoff
- Timeout: 60s

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── analyzer/
│   ├── index.ts          # analyzePost + client init
│   └── prompt-loader.ts  # Story 2.2
├── types/
│   └── posts.ts          # Ajouter AnalysisResult
tests/
├── integration/
│   └── analyzer.test.ts
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/integration/analyzer.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Mock @anthropic-ai/sdk

**Tests requis:**

1. Envoie correctement un post à Claude
2. Parse la réponse JSON de Claude
3. Retry sur erreur 429
4. Throw AnalyzerError après 3 retries échoués
5. Respecte le timeout de 60s

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered.

### Completion Notes List

- Installed @anthropic-ai/sdk ^0.71.2
- Created analyzer module with `analyzePost()` function
- Implemented retry with exponential backoff (BASE_DELAY_MS=1000, RATE_LIMIT_DELAY_MS=5000)
- Rate limit (429) errors use longer delay (5s vs 1s base)
- Timeout set to 60s using AbortController
- All errors logged with structured logger
- 12 integration tests covering all acceptance criteria

### File List

| File                                                 | Status                                               |
| ---------------------------------------------------- | ---------------------------------------------------- |
| `tech-watch-tool/package.json`                       | Modified - added @anthropic-ai/sdk dependency        |
| `tech-watch-tool/src/analyzer/index.ts`              | Created - analyzePost function with retry logic      |
| `tech-watch-tool/src/types/posts.ts`                 | Modified - added AnalysisResult interface            |
| `tech-watch-tool/src/types/errors.ts`                | Modified - added AnalyzerError class                 |
| `tech-watch-tool/src/types/index.ts`                 | Modified - exported AnalysisResult and AnalyzerError |
| `tech-watch-tool/tests/integration/analyzer.test.ts` | Created - 12 tests with mocked SDK                   |

---

## QA Results

### Review Date: 2025-12-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent implementation.** The code is clean, well-structured, and follows established patterns. The analyzer module correctly implements the Claude API integration with proper error handling, retry logic, and comprehensive test coverage.

**Strengths:**

- Clean separation of concerns (getClient, buildPrompt, parseAnalysisResponse, analyzePost)
- Proper use of constants for configuration values (CLAUDE_MODEL, MAX_TOKENS, etc.)
- Comprehensive response validation in parseAnalysisResponse()
- Good logging with structured format throughout
- Exponential backoff with special handling for rate limits
- Timeout implementation using AbortController

**Minor observations (not blocking):**

- Module-level client caching (`let client: Anthropic | null`) works but could be refactored for better testability in future
- The `parseAnalysisResponse` retries on parse errors, which may not be desirable (Claude won't return different JSON on retry)

### Refactoring Performed

None required. Code quality is production-ready.

### Compliance Check

- Coding Standards: ✓
  - TypeScript strict mode
  - Named constants (SCREAMING_SNAKE_CASE)
  - camelCase functions
  - PascalCase types
  - Structured logger usage
  - Custom error classes (AnalyzerError)
  - No `any` types
  - Secrets from process.env only
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ Integration tests with mocked SDK, 12 test cases, fake timers for retry tests
- All ACs Met: ✓ See traceability below

### Requirements Traceability

| AC                         | Test Coverage                                                                                     | Status |
| -------------------------- | ------------------------------------------------------------------------------------------------- | ------ |
| AC1: SDK installed         | package.json verified                                                                             | ✓      |
| AC2: API key from env      | `should throw AnalyzerError if ANTHROPIC_API_KEY is not set`                                      | ✓      |
| AC3: analyzePost function  | `should send a post to Claude and return parsed response`, `should parse JSON response correctly` | ✓      |
| AC4: Retry with 3 attempts | `should retry on rate limit error (429)`, `should throw AnalyzerError after 3 failed retries`     | ✓      |
| AC5: Unit test with mock   | 12 tests with mocked @anthropic-ai/sdk                                                            | ✓      |

### Improvements Checklist

All items handled - no unchecked items:

- [x] Proper error class (AnalyzerError) extending PipelineError
- [x] Exponential backoff implemented (BASE_DELAY_MS \* 2^attempt)
- [x] Rate limit (429) uses longer delay (5000ms vs 1000ms base)
- [x] 60s timeout with AbortController
- [x] Structured logging for all error scenarios
- [x] Response validation for all AnalysisResult fields

### Security Review

✓ **No security concerns.**

- API key read from environment variable only
- No hardcoded secrets
- Input validation on Claude response prevents malformed data propagation

### Performance Considerations

✓ **No performance concerns for current use case.**

- Lazy client initialization (singleton pattern)
- Appropriate timeout (60s) for LLM API calls
- Rate limit backoff prevents hammering API

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.1-claude-api-integration.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no blocking issues.
