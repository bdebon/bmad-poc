# Story 3.1: Notion API Integration

## Status

Done

## Story

**As a** developer,
**I want** to connect to Notion API,
**so that** I can create entries in Benjamin's database.

## Acceptance Criteria

1. Le package `@notionhq/client` est installé et configuré
2. La clé API Notion et l'ID de la database sont lus depuis `.env`
3. Une fonction `createNotionEntry(post: ScoredPost)` crée une page dans la database
4. Les erreurs API sont gérées avec retry
5. Un test avec mock valide l'intégration

## Tasks / Subtasks

- [x] Task 1: Installer le SDK Notion (AC: 1)

  - [x] `npm install @notionhq/client`
  - [x] Vérifier que le package est ajouté au package.json

- [x] Task 2: Créer le module publisher (AC: 2, 3)

  - [x] Créer `src/publisher/index.ts`
  - [x] Lire `NOTION_API_KEY` et `NOTION_DATABASE_ID` depuis `process.env`
  - [x] Initialiser le client Notion
  - [x] Implémenter `createNotionEntry(post: ScoredPost): Promise<NotionEntry>`

- [x] Task 3: Définir le type NotionEntry (AC: 3)

  - [x] Créer `src/types/notion.ts` avec interface `NotionEntry`
  - [x] Exporter depuis `src/types/index.ts`

- [x] Task 4: Implémenter la gestion d'erreurs et retry (AC: 4)

  - [x] Créer `PublisherError` dans `src/types/errors.ts`
  - [x] Implémenter retry avec backoff (3 retries, 1s)
  - [x] Timeout de 15s
  - [x] Logger les erreurs avec format structuré

- [x] Task 5: Exporter le module (AC: 3)

  - [x] Mettre à jour `src/publisher/index.ts` avec barrel export

- [x] Task 6: Écrire les tests (AC: 5)
  - [x] Créer `tests/integration/publisher.test.ts`
  - [x] Mock le SDK Notion
  - [x] Tester la création d'une page
  - [x] Tester le retry sur erreur
  - [x] Tester le timeout

## Dev Notes

### Dépendances Stories Précédentes

Cette story dépend de :

- **Epic 2 complet** — type `ScoredPost` disponible

### Notion API [Source: architecture/external-apis.md#notion-api]

**Base URL:** `https://api.notion.com/v1`

**Endpoint:**

- `POST /pages` — Créer une nouvelle page dans la database

**Authentication:** Header `Authorization: Bearer ${NOTION_API_KEY}`

**Rate Limits:** 3 requests/second (average)

### SDK Notion [Source: architecture/tech-stack.md]

```typescript
import { Client } from "@notionhq/client";

const notion = new Client({
  auth: process.env.NOTION_API_KEY,
});

const response = await notion.pages.create({
  parent: { database_id: process.env.NOTION_DATABASE_ID },
  properties: {
    // ... voir Story 3.2 pour le format
  },
});
```

### Type NotionEntry [Source: architecture/data-models.md#notionentry]

```typescript
interface NotionEntry {
  id: string; // ID de la page Notion créée
  title: string;
  description: string; // Justification Claude
  sourceUrls: string[]; // Liens vers Reddit/HN/article
  sources: string[]; // ['Reddit', 'HN']
  relevanceScore: number;
  tags: string[];
  rating: null; // Vide pour feedback manuel
  date: Date;
  createdAt: Date; // Timestamp création Notion
}
```

### Interface Publisher [Source: architecture/components.md#publisher-module]

```typescript
publishToNotion(posts: ScoredPost[]): Promise<NotionEntry[]>
createNotionPage(post: ScoredPost): Promise<NotionEntry>
```

### Error Handling [Source: architecture/error-handling-strategy.md]

```typescript
class PublisherError extends PipelineError {
  constructor(message: string, public readonly cause?: Error) {
    super(message);
  }
}
```

**Retry Policy Notion API:**

- 3 retries
- Backoff: 1s fixe
- Timeout: 15s

### Source Tree [Source: architecture/source-tree.md]

```
src/
├── publisher/
│   └── index.ts              # createNotionEntry, publishToNotion
├── types/
│   ├── index.ts
│   └── notion.ts             # NotionEntry
tests/
├── integration/
│   └── publisher.test.ts
```

## Testing

### Standards [Source: architecture/test-strategy-and-standards.md]

- **Framework:** Vitest 2.0
- **Location:** `tests/integration/publisher.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert)
- **Mocking:** Mock @notionhq/client

**Tests requis:**

1. Crée correctement une page Notion
2. Retourne un NotionEntry avec l'ID de la page
3. Retry sur erreur réseau
4. Throw PublisherError après 3 retries échoués
5. Respecte le timeout de 15s

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2025-12-10 | 0.1     | Initial draft           | SM Agent (Bob)    |
| 2025-12-11 | 1.0     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Installed `@notionhq/client` v5.4.0
- Created `src/publisher/index.ts` with `createNotionEntry()` and `publishToNotion()` functions
- Created `src/types/notion.ts` with `NotionEntry` interface
- Added `PublisherError` class to `src/types/errors.ts`
- Implemented retry logic with 3 retries, 1s fixed backoff, 15s timeout
- Environment variables: `NOTION_API_KEY`, `NOTION_DATABASE_ID` (already documented in `.env.example`)
- All 11 integration tests pass
- Full test suite: 80 tests passing

### File List

| File                                  | Status                                         |
| ------------------------------------- | ---------------------------------------------- |
| `src/publisher/index.ts`              | Created                                        |
| `src/types/notion.ts`                 | Created                                        |
| `src/types/errors.ts`                 | Modified (added PublisherError)                |
| `src/types/index.ts`                  | Modified (exports NotionEntry, PublisherError) |
| `tests/integration/publisher.test.ts` | Created                                        |
| `package.json`                        | Modified (@notionhq/client added)              |

---

## QA Results

_To be filled by QA agent_
